# 3.Mockitoの使い方

## 3.1.Mockitoとは
Mockitoは,Javaのユニットテストのために開発されたモックフレームワーク(mocking framework)です.テストで,モックオブジェクトを直感的に操作することを目的として開発されています.  
キレイでシンプルなAPIでモックを扱うテストコードを記述できること,また記述されたテストコードの可読性が高くわかりやすい検証エラーを生成することがMockitoの特徴です.

## 3.2.モックオブジェクトとは
モックオブジェクトはテスト対象から呼び出される依存先のオブジェクトに代わって使用されるテスト用のオブジェクトです.  
モックオブジェクトは,テスト対象が呼び出す依存先と同じインターフェースを持ち外部からは期待した振る舞いで動いているように見えます(呼び出したメソッドが実装されているかのように見える).しかし、実際は内部ロジック(内部のコード)が実装されていません.その実装のかわりに,与えられたパラメータ(引数)に対してどのような結果で返すのか(返り値)を事前にモックオブジェクトに定義する必要があります.  

モック化が想定されるケース
* 依存する部品で任意の内容をテスト対象に返すのが困難な場合  
　※たとえばHDDの容量不足というエラーを出力する必要がある試験の場合
* 依存する部品を利用すると別の試験で副作用が発生する場合  
　※たとえばデーターベースの特定のテーブルを全て削除するような試験を行う場合
* 依存する部品がまだ完成していない場合  
　※たとえばテスト対象のプログラムと依存する部品が並行で開発されている場合  
 etc...  
 
### モックオブジェクトの種類
モックオブジェクトには,スタブやモックなどのオブジェクトが備わっている.スタブやモックはオブジェクトですが、Mockitoではモックオブジェクトを介してスタブやモックの操作を行うためそれらを機能として捉えると理解しやすい.  

テストを目的として本物のオブジェクトの動作を真似ているスタブやモックなどのオブジェクトの総称をテストダブルと呼ぶ.  
テストダブルは5つの代役として、ダミー、フェイク、スタブ、モック、スパイを定義している.  

#### スタブ
* メソッドの実行に対して,事前に定義された振る舞い(引数、返り値)を提供するオブジェクト.外部の依存性を排除し,テストがオブジェクトの実装の正しさだけに注目する目的で使われている.
#### モック 
* メソッドの実行に対して,実行回数やパラメータの呼び出しを記録するオブジェクト.テスト対象から呼び出されたスタブの動作を記録し,その記録からメソッドの実行回数などを検証します.  
#### スパイ
* メソッドの実行に対して,実行回数やパラメータの呼び出しを記録するオブジェクトです.モックと同様の役割ですが,基本的な定義として,モックはメソッドの実行中に検証するのに対して,スパイはメソッドの実行後に検証するという違いがあります.  
Mockitoで扱う検証メソッドではメソッドの実行後に検証するので両者の違いはありませんが,Mockitoにおけるスパイはオブジェクトを部分的にモックする用途で使用されています.  

## 3.3.Mockitoにできないこと
モック化できないのが
* privateメソッド
* staticメソッド
* protectedメソッド
* インスタンス生成(new)
など

上記以外であれば基本的にmockitoでモック化することができる.
上記4つをモック化する場合には,Mockitoとは別で[PowerMock]()を用いる必要がある.  

## 3.4.モック化

## 戻り値のあるpublicなメソッドの場合

### 1.thenメソッド
```php
Mockito.when(モックインスタンス).メソッド(任意の引数).thenReturn(任意の戻り値);
// モックされたクラスのメソッドが呼ばれた時、この戻り値を返す
```
これでメソッドはモック化され,際にメソッドは実行されず任意の戻り値を返すだけのモックとなる.

頭のMockito.は,あってもなくてもどちらでも大丈夫.
PowerMockでも同じような書き方をするため,同時に使用する場合は使い分ける必要がある.

### 2.doメソッド
```php
Mockito.doReturn(任意の戻り値).when(モックインスタンス).メソッド(任意の引数);
// モックされたクラスのメソッドが呼ばれた時この戻り値を返す
```
thenメソッドと全く同じ挙動を取る.
下記の通り,**thenメソッドでは対応できない場合がある**ので`do`メソッドで統一していれば間違いないはず

## 戻り値のないpublicvoidなメソッドの場合

`public void`この場合は、doメソッドでしか記述できない.
```php
Mockito.doNothing().when(モックインスタンス).メソッド(任意の引数);
// モッククラスのメソッドが呼ばれた時,何も返さない
```
## モック化したメソッドの引数を検証する(ArgumentCaptor)
### ArgumentCaptor
```php
ArgumentCaptor<型> 変数 = ArgumentCaptor.forClass(型.class);
// forClass()メソッドで,その型の容れ物(変数)をつくる
```
メソッドはモック化したのでその中を検証する必要はありませんが、モック化したメソッドに渡す引数は正しいかという検証必要がある.
そんな時に使えるのがArgumentCaptorです.
### capture()メソッド
上の変数をメソッドのモック化をする時に引数として渡すと,実際に渡される引数をキャプチャして変数に格納する.
```php
Mockito.doReturn("戻り値").when(クラス).メソッド(変数.capture());
// forClass()メソッドで,その型の容れ物（変数）をつくる
```
